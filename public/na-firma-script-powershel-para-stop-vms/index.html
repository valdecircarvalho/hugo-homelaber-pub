<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Na FIRMA - Script Powershel para Stop de VMs :: Blog Homelaber Brasil |  — Homelab·Infraestrutura de TI· Cloud Computing· DevOps</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Olá Homelabers!
Hoje vou falar sobre um script em Powershell que eu usei na FIRMA para fazer o shutdown de todas as VMs do meu ambiente. Tivemos que mudar fisicamente de lugar todos os servidores do ambiente e para isso, realizamos alguns &amp;ldquo;ensaios&amp;rdquo; para garantir que tudo sairia com o planejado no dia D. No primeiro ensaio, acabei por derrubar VM por VM via console do vSphere, mas isso não é uma coisa legal de se fazer quanto você tem mais de 100 VMs em Produção no seu ambiente."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/na-firma-script-powershel-para-stop-vms/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Na FIRMA - Script Powershel para Stop de VMs"/>
<meta name="twitter:description" content="Olá Homelabers!
Hoje vou falar sobre um script em Powershell que eu usei na FIRMA para fazer o shutdown de todas as VMs do meu ambiente. Tivemos que mudar fisicamente de lugar todos os servidores do ambiente e para isso, realizamos alguns &ldquo;ensaios&rdquo; para garantir que tudo sairia com o planejado no dia D. No primeiro ensaio, acabei por derrubar VM por VM via console do vSphere, mas isso não é uma coisa legal de se fazer quanto você tem mais de 100 VMs em Produção no seu ambiente."/>



<meta property="og:title" content="Na FIRMA - Script Powershel para Stop de VMs" />
<meta property="og:description" content="Olá Homelabers!
Hoje vou falar sobre um script em Powershell que eu usei na FIRMA para fazer o shutdown de todas as VMs do meu ambiente. Tivemos que mudar fisicamente de lugar todos os servidores do ambiente e para isso, realizamos alguns &ldquo;ensaios&rdquo; para garantir que tudo sairia com o planejado no dia D. No primeiro ensaio, acabei por derrubar VM por VM via console do vSphere, mas isso não é uma coisa legal de se fazer quanto você tem mais de 100 VMs em Produção no seu ambiente." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/na-firma-script-powershel-para-stop-vms/" />
<meta property="article:published_time" content="2016-05-12T10:00:52+00:00" />
<meta property="article:modified_time" content="2016-05-12T10:00:52+00:00" /><meta property="og:site_name" content="Blog Homelaber Brasil | " />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Homelaber Brasil</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/archive">arquivo</a></li>
        
      
        
          <li><a href="/sobre">sobre</a></li>
        
      
        
          <li><a href="https://github.com/valdecircarvalho/">github</a></li>
        
      
        
          <li><a href="https://twitter.com/homelaber">@homelaber</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/archive">arquivo</a></li>
      
    
      
        <li><a href="/sobre">sobre</a></li>
      
    
      
        <li><a href="https://github.com/valdecircarvalho/">github</a></li>
      
    
      
        <li><a href="https://twitter.com/homelaber">@homelaber</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/na-firma-script-powershel-para-stop-vms/">Na FIRMA - Script Powershel para Stop de VMs</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            12-05-2016
        </span>
      
      <span class="post-author">— Written by Valdecir Carvalho</span>
      
        <span class="post-read-time">— 4 min lendo</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/guest-stop-vm/">Guest Stop-VM</a>&nbsp;
        
          #<a href="/tags/microsoft-powershell/">microsoft powershell</a>&nbsp;
        
          #<a href="/tags/powercli/">PowerCli</a>&nbsp;
        
          #<a href="/tags/powershell/">powershell</a>&nbsp;
        
          #<a href="/tags/script/">script</a>&nbsp;
        
          #<a href="/tags/script-para-parar-vms/">script para parar vms</a>&nbsp;
        
          #<a href="/tags/script-to-shutdown-virtual-machines/">script to shutdown virtual machines</a>&nbsp;
        
          #<a href="/tags/shutdown/">shutdown</a>&nbsp;
        
          #<a href="/tags/shutdown-vm/">Shutdown-VM</a>&nbsp;
        
          #<a href="/tags/vcenter/">vcenter</a>&nbsp;
        
          #<a href="/tags/vm-shutdown/">vm shutdown</a>&nbsp;
        
          #<a href="/tags/vmware/">vmware</a>&nbsp;
        
          #<a href="/tags/vmware-powercli/">vmware powercli</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <p>Olá Homelabers!</p>
<p>Hoje vou falar sobre um script em Powershell que eu usei na FIRMA para fazer o shutdown de todas as VMs do meu ambiente. Tivemos que mudar fisicamente de lugar todos os servidores do ambiente e para isso, realizamos alguns &ldquo;ensaios&rdquo; para garantir que tudo sairia com o planejado no dia D. No primeiro ensaio, acabei por derrubar VM por VM via console do vSphere, mas isso não é uma coisa legal de se fazer quanto você tem mais de 100 VMs em Produção no seu ambiente.</p>
<p>Pesquisei um pouco nas internets da vida e encontrei um script bem parecido com o que eu queria. Fiz algumas modificações e reformas para se adequar ao meu ambiente e o resultado é o código que você encontra aqui embaixo.</p>
<p><img src="/imagens/2016/05/powercli.png" alt="powercli"></p>
<!-- raw HTML omitted -->
<p>Esse código basicamente, lê um arquivo TXT chamado VMLIST.TXT com uma lista de todas as VMs que eu queria derrubar. O script faz um loop pelo arquivo e vai logando em um arquivo texto o resultado de cada shutdown, junto com o tempo gasto na operação. Esse log, foi bastante útil para conseguir medir o tempo exato e planejar a janela de mudança, uma vez que bastava disparar o código, abrir um Redbull (essas coisas são sempre feitas na madrugada) e esperar.</p>
<p>Outra curiosidade do código, é que ele tenta derrumar a VM de uma forma &ldquo;graciosa&rdquo;, com o comando &ldquo;<a href="https://www.vmware.com/support/developer/windowstoolkit/wintk40u1/html/Shutdown-VMGuest.html">Shutdown-VMGuest</a>&rdquo; ou seja, dando o comando para o VMware Tools desligar o SO e depois fazer o halt da máquina. Caso não consiga, ele vai no modo bruto mesmo, com o comando &ldquo;<a href="https://www.vmware.com/support/developer/PowerCLI/PowerCLI41U1/html/Stop-VM.html">Stop-VM</a>&rdquo; tipo um DEDOFF. E importante, se você derrubar um monte de VMs de uma vez, você pode ter problemas, por isso, o código espera 30 segundos entre cada VM.</p>
<p>O código está bastante fácil de ser modificado, caso seja necessário cobrir alguma particularidade do seu ambiente, mas pode ser utilizado AS-IS que vai funcionar.</p>
<p>[su_box title=&quot;ATENÇÃO&rdquo; style=&quot;glass&rdquo; box_color=&rdquo;#FF0000&rdquo;]<strong>NUNCA</strong> execute um script que você encontraR na internet (nem aqui desse site super confiável) diretamente em seu ambiente de produção. Antes, faça um teste em homologação ou em laboratório.
E mais uma coisa, <em>eu não me responsabilizo</em> por qualquer dano que por ventura esse código venha causar no seu ambiente OK?[/su_box]</p>
<p>Outro uso uso interessante para esse código é derrubar o seu LAB quando for necessário. Fácil, rápido e prático!</p>
<p><img src="/imagens/2016/05/production-we-are-trying.jpg" alt="production-we-are-trying"></p>
<p>É isso ai galera! Vou ficando por aqui! Se você gostou desse post com script ou se esse script foi útil para você, deixe um comentário aqui no post.</p>
<p>VC</p>
<p>Ah(1), quase ia me esquecendo de comentar, que para executar esse script, você precisa ter o VMware PowerCLI instalado em seu computador (<a href="https://my.vmware.com/group/vmware/get-download?downloadGroup=PCLI630R1">link para a versão 6.3</a>)</p>
<p>Ahh(2), mais uma coisa que lembrei depois. A maneira mais fácil e rápida de de gerar o TXT com as suas VMs, é utilizando o <a href="http://homelaber.com.br/nova-versao-do-rvtools-acaba-de-ser-lancada/">RVTools</a> conforme eu já comentei <a href="http://homelaber.com.br/nova-versao-do-rvtools-acaba-de-ser-lancada/">aqui</a> e o Excel.</p>
<p><em>Script: vm-shutdown.ps1 (<a href="https://gist.github.com/homelaber/362a74112244f1cbd99885f7ce4d7b17">código disponibilizado no gist do Homelaber</a>)</em></p>
<pre><code>##########################################################################################################
#SCRIPT PARA SHUTDOWN DE VIRTUAL MACHINES NO VCENTER
#
#USO:
#CRIAR UM ARQUIVO TXT NO FORMATO ABAIXO COM O NOME DE VMLIST.TXT
#
#name
#VM01
#VM01
#VM03
#
#VERSÃO 1
#FALTA MELHORAR A PARTE DE LOG E CATCH DE ERRO....
#########################################################################################################
clear
#função que cria um arquivo de log 
function LogMessage ([String[]] $messages)
{
 
   $timestamp = $([DateTime]::Now).ToString()
 
   foreach ($message in $messages)
   {
      if ([string]::IsNullOrEmpty($message))
      {
         continue
      }
 
      Write-Host &quot;$message&quot;
 
      $message = $message.Replace(&quot;`r`n&quot;, &quot; &quot;)
      $message = $message.Replace(&quot;`n&quot;, &quot; &quot;)
      Add-Content $logFile &quot;$timestamp $message&quot;
   }
}

#POWER OFF
Add-PSSnapin VMware.VimAutomation.Core  
clear  
$vcenter=&quot;COLOCAR O NOME DO SEU VCENTER SERVER AQUI&quot; 
$mycredentials = Get-Credential 
$scriptDir = Split-Path $MyInvocation.MyCommand.Path
$logfile = $scriptDir + &quot;\log.txt&quot; 
$vmlistfile = $scriptDir + &quot;\vmlist.txt&quot;
$waittime = 30

LogMessage &quot;Iniciando Shudown das VMs:&quot; 
Import-Csv $vmlistfile |  
foreach {  
    $strNewVMName = $_.name
    Write-Host $strNewVMName
    }

LogMessage &quot;===========================================================================================&quot;
#Connect to vcenter server  
LogMessage &quot;Conectando no servidor Vcenter: $vcenter ...&quot;

$success = Connect-VIServer $vcenter -Credential $mycredentials -WarningAction:SilentlyContinue
if ($success) { Write-Host &quot;Conectado com sucesso ao servidor vCenter: $vcenter&quot; -Foregroundcolor Green }
else
{
    Write-Host &quot;Não foi possível conectar ao servidor cCenter: $vcenter&quot; -Foregroundcolor Red
    LogMessage &quot;Não foi possível conectar ao servidor cCenter: $vcenter&quot;
    exit
}
Write-Host &quot;&quot;
  
#Import vm name from csv file  
LogMessage &quot;Carregando arquivo de vms...&quot;

Import-Csv $vmlistfile |  
foreach {  
    $strNewVMName = $_.name  
  
    #Generate a view for each vm to determine power state  
    $vm = Get-View -ViewType VirtualMachine -Filter @{&quot;Name&quot; = $strNewVMName}  
  
    #If vm is powered on then VMware Tools status is checked  
           if ($vm.Runtime.PowerState -ne &quot;PoweredOff&quot;) {  
               if ($vm.config.Tools.ToolsVersion -ne 0) { 
                
                   LogMessage &quot;Processando VM: ++ $strNewVMName ++ ...&quot;
                   
                   #Commando de Shutdown...                 
                   Shutdown-VMGuest $strNewVMName -Confirm:$false
                   
                   LogMessage &quot;Executando shutdown da VM ++ $strNewVMName ++ via VNMware Tools.Aguardando... (30s)&quot;
                   
                   sleep 30
                   
               }  
               else {  
                    
                    LogMessage &quot;Processando VM: ++ $strNewVMName ++ ...&quot;
                   
                    #Commando de Shutdown...          
                    Stop-VM $strNewVMName -Confirm:$false 

                    LogMessage &quot;Executando shutdown da VM: ++ $strNewVMName ++ via Force Stop.Aguardando... (30s)&quot;
                    
                    sleep 30        
                  
               }  
           }  
}  
  

#Disconnect vcenter server  
LogMessage &quot;Desconectando servidor Vcenter...&quot;
disconnect-viserver $vcenter -Confirm:$false
sleep 5
LogMessage &quot;Servidor Vcenter Desconectado!&quot;
</code></pre>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Leia outros posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/preparando-uma-vm-red-hat-enterprise-linux-para-desenvolvimento/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Preparando uma VM Red Hat Enterprise Linux para Desenvolvimento</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/pluralsigth-uma-das-muitas-vantagens-de-ser-um-vexpert/">
                  <span class="button__text">Pluralsigth - Uma das muitas vantagens de ser um vEXPERT</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    
    

    
      
        

      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">2016-2019 - Homelaber Brasil - Valdecir Carvalho</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
